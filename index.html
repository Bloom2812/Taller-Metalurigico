<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corinfar Taller - Sistema de Gestión</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --success: #2ecc71;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
            
            /* Colores Kanban */
            --design: #8e44ad;
            --fabricacion: #3498db;
            --control: #f39c12;
            --terminado: #2ecc71;
            --entregado: #7f8c8d;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ========== PANTALLA DE LOGIN ========== */
        .login-container {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        .login-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .login-header h1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .login-header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .login-body {
            padding: 40px 30px;
        }

        .login-form .form-group {
            margin-bottom: 25px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .login-form input:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
        }

        .input-with-icon input {
            padding-left: 50px;
        }

        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            font-size: 0.9rem;
        }

        .remember {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remember input {
            width: auto;
        }

        .forgot-password {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 500;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .login-footer {
            text-align: center;
            padding: 20px;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: shake 0.5s ease;
        }

        .error-message.show {
            display: block;
        }

        /* ========== SISTEMA PRINCIPAL (oculto inicialmente) ========== */
        .main-system {
            display: none;
        }

        .main-system.active {
            display: block;
        }

        /* ========== ESTILOS DEL SISTEMA PRINCIPAL ========== */
        .container {
            display: flex;
            min-height: 100vh;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
        }

        /* SIDEBAR */
        .sidebar {
            width: 250px;
            background: var(--primary);
            color: white;
            padding: 20px 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1001;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .logo {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .logo h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--secondary);
        }

        .user-info-sidebar {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--secondary);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        .logout-btn {
            margin: 20px;
            padding: 12px;
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        /* CONTENIDO PRINCIPAL */
        .main-content {
            flex: 1;
            min-height: 100vh;
            width: 100%;
            padding: 10px;
        }

        .page-content {
            display: none;
            min-height: calc(100vh - 20px);
        }

        .page-content.active {
            display: block;
        }

        /* HEADER COMÚN */
        .page-header {
            background: white;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
            margin-right: 10px;
        }

        .page-title {
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.8rem;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--accent);
            color: white;
        }

        .btn-filter {
            background: white;
            color: #2c3e50;
            border: 2px solid #e0e0e0;
        }

        .btn-filter:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 12px 15px 12px 45px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 300px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--secondary);
            outline: none;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #95a5a6;
        }

        /* ========== ESTILOS DASHBOARD ========== */
        /* TARJETAS DE RESUMEN */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .icon-blue { background: var(--secondary); }
        .icon-green { background: var(--success); }
        .icon-red { background: var(--accent); }
        .icon-orange { background: #f39c12; }

        .stat-info h3 {
            font-size: 1.5rem;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .stat-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* SECCIONES */
        .section {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 15px;
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 10px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .dashboard-sections {
                grid-template-columns: 1fr;
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light);
        }

        .section-title {
            font-size: 1.4rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* TABLAS */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--light);
            font-size: 0.9rem;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--light);
            font-size: 0.9rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .btn-view { background: var(--secondary); }
        .btn-edit { background: #f39c12; }
        .btn-delete { background: var(--accent); }

        /* ========== ESTILOS KANBAN ========== */
        .solicitudes .column-header { background: #7f8c8d; }
        :root { --solicitudes: #7f8c8d; }
        .kanban-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            height: calc(100vh - 200px);
            margin-bottom: 15px;
        }

        .kanban-column {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        .column-header {
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .design .column-header { background: var(--design); }
        .fabricacion .column-header { background: var(--fabricacion); }
        .control .column-header { background: var(--control); }
        .terminado .column-header { background: var(--terminado); }
        .entregado .column-header { background: var(--entregado); }

        .column-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .column-count {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .column-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* TARJETAS KANBAN */
        .kanban-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 5px solid;
            transition: all 0.3s;
            cursor: grab;
            position: relative;
        }

        .kanban-card:active {
            cursor: grabbing;
            transform: rotate(2deg);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .kanban-card.design { border-left-color: var(--design); }
        .kanban-card.fabricacion { border-left-color: var(--fabricacion); }
        .kanban-card.control { border-left-color: var(--control); }
        .kanban-card.terminado { border-left-color: var(--terminado); }
        .kanban-card.entregado { border-left-color: var(--entregado); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .card-codigo {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 600;
            padding: 4px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            display: inline-block;
        }

        .card-priority {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .priority-alta { background: #ffebee; color: #c62828; }
        .priority-media { background: #fff8e1; color: #f57c00; }
        .priority-baja { background: #e8f5e9; color: #2e7d32; }

        .card-image {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            position: relative;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .kanban-card:hover .card-image img {
            transform: scale(1.05);
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .card-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #636e72;
        }

        .meta-item i {
            width: 16px;
            color: #3498db;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tag {
            padding: 4px 10px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tag.material { background: #e8f5e9; color: #2e7d32; }
        .tag.urgente { background: #ffebee; color: #c62828; }
        .tag.nuevo { background: #f3e5f5; color: #7b1fa2; }

        .card-progress {
            margin-bottom: 15px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #636e72;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .design .progress-fill { background: var(--design); }
        .fabricacion .progress-fill { background: var(--fabricacion); }
        .control .progress-fill { background: var(--control); }
        .terminado .progress-fill { background: var(--terminado); }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .card-time {
            font-size: 0.9rem;
            color: #636e72;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            color: #636e72;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn-small:hover {
            background: var(--secondary);
            color: white;
            transform: translateY(-2px);
        }

        /* DRAG AND DROP */
        .dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drop-zone {
            background: rgba(52, 152, 219, 0.1);
            border: 2px dashed var(--secondary);
            border-radius: 10px;
            min-height: 100px;
            margin: 10px;
            transition: all 0.3s;
        }

        /* MODALES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 25px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .close-modal {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* PÁGINAS DE GESTIÓN */
        .management-container {
            padding-bottom: 30px;
        }

        /* RESPONSIVE */
        @media (max-width: 1400px) {
            .kanban-container {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .kanban-column.entregado, .kanban-column.control {
                display: none;
            }
        }

        @media (max-width: 1200px) {
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .btn-menu-toggle {
                display: block;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }

        @media (max-width: 1024px) {
            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .kanban-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .search-box input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 10px;
            }

            .kanban-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .page-title {
                font-size: 1.4rem;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                padding: 15px;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }

            .section {
                margin-bottom: 10px;
                padding: 10px;
            }
            
            .login-box {
                max-width: 100%;
            }
        }

        /* ANIMACIONES */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .kanban-card, .stat-card {
            animation: fadeIn 0.5s ease;
        }

        /* Logo Corinfar */
        .corinfar-logo {
            font-weight: 700;
            color: var(--secondary);
        }

        .corinfar-title {
            color: var(--primary);
            font-weight: 600;
        }
    </style>

    <!-- Firebase SDK Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    </head>
<body>
    <!-- ========== PANTALLA DE LOGIN ========== -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <h1><i class="fas fa-industry"></i> <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                <p>Sistema de Gestión de Taller Metalúrgico</p>
            </div>
            
            <div class="login-body">
                <div id="loginError" class="error-message">
                    <i class="fas fa-exclamation-circle"></i> Usuario o contraseña incorrectos
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="username">Usuario</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="username" placeholder="Ingrese su usuario" required autocomplete="username">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Contraseña</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="password" placeholder="Ingrese su contraseña" required autocomplete="current-password">
                        </div>
                    </div>
                    
                    <div class="remember-forgot">
                        <div class="remember">
                            <input type="checkbox" id="remember">
                            <label for="remember">Recordarme</label>
                        </div>
                        <a href="#" class="forgot-password" onclick="forgotPassword()">¿Olvidó su contraseña?</a>
                    </div>
                    
                    <button type="submit" class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                </form>
            </div>
            
            <div class="login-footer">
                <p>Versión 2.0 © 2024 Corinfar Taller - Todos los derechos reservados</p>
            </div>
        </div>
    </div>

    <!-- ========== SISTEMA PRINCIPAL ========== -->
    <div class="main-system" id="mainSystem">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <div class="container">
            <!-- SIDEBAR DE NAVEGACIÓN -->
            <nav class="sidebar">
                <div class="logo">
                    <h1><i class="fas fa-industry"></i> <span class="logo-text corinfar-logo">CORINFAR</span> <span class="logo-text corinfar-title">Taller</span></h1>
                </div>
                
                <div class="user-info-sidebar">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-name" id="sidebarUserName">Administrador</div>
                    <div class="user-role" id="sidebarUserRole">Administrador del Sistema</div>
                </div>
                
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="kanban">
                            <i class="fas fa-th-large"></i>
                            <span class="nav-text">Tablero Kanban</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="piezas">
                            <i class="fas fa-cogs"></i>
                            <span class="nav-text">Piezas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="inventario">
                            <i class="fas fa-boxes"></i>
                            <span class="nav-text">Inventario</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="herramientas">
                            <i class="fas fa-tools"></i>
                            <span class="nav-text">Herramientas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="planos">
                            <i class="fas fa-file-pdf"></i>
                            <span class="nav-text">Planos</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-page="reportes">
                            <i class="fas fa-chart-bar"></i>
                            <span class="nav-text">Reportes</span>
                        </a>
                    </li>
                </ul>
                
                <div class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </div>
            </nav>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="main-content">
                <!-- ========== DASHBOARD ========== -->
                <div id="dashboard" class="page-content active">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-tachometer-alt"></i> Dashboard - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <div class="header-controls">
                            <span style="font-weight: 600; color: var(--dark);">Taller Metalúrgico Industrial</span>
                            <button class="btn btn-primary" onclick="navigateTo('kanban')">
                                <i class="fas fa-th-large"></i> Ver Tablero Kanban
                            </button>
                        </div>
                    </div>

                    <!-- ESTADÍSTICAS -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-icon icon-blue">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="stat-info">
                                <h3>0</h3>
                                <p>Piezas Activas</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon icon-green">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-info">
                                <h3>0</h3>
                                <p>En Inventario</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon icon-red">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3>0</h3>
                                <p>Stock Bajo</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon icon-orange">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <h3>0</h3>
                                <p>Pedidos Pendientes</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-sections">
                        <!-- PIEZAS RECIENTES -->
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title"><i class="fas fa-history"></i> Piezas Recientes</h2>
                                <button class="btn btn-primary" onclick="navigateTo('piezas')">
                                    <i class="fas fa-eye"></i> Ver Todas
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Código</th>
                                            <th>Nombre</th>
                                            <th>Material</th>
                                            <th>Tiempo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody><tr><td colspan="6" style="text-align:center">Cargando datos...</td></tr></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ALERTAS -->
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title"><i class="fas fa-bell"></i> Alertas de Inventario</h2>
                            </div>
                            <div class="alertas">
                                <p>Cargando alertas...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== TABLERO KANBAN ========== -->
                <div id="kanban" class="page-content">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-th-large"></i> Tablero Kanban - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <div class="header-controls">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Buscar pieza, código o material..." id="searchInput">
                            </div>
                            <button class="btn btn-filter">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                            <button class="btn btn-primary" onclick="showModal('modal-nueva-pieza')">
                                <i class="fas fa-plus"></i> Nueva Pieza
                            </button>
                        </div>
                    </div>

                    <!-- KANBAN BOARD -->
                    <div class="kanban-container" id="kanbanBoard">
                        <!-- COLUMNA 0: SOLICITUDES (Desde CMMS) -->
                        <div class="kanban-column solicitudes">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-download"></i>
                                    <span>Solicitudes</span>
                                </div>
                                <div class="column-count">0</div>
                            </div>
                            <div class="column-content" data-status="solicitudes">
                                <!-- Las solicitudes del CMMS aparecerán aquí -->
                            </div>
                        </div>

                        <!-- COLUMNA 1: DISEÑO -->
                        <div class="kanban-column design">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-pencil-ruler"></i>
                                    <span>Diseño</span>
                                </div>
                                <div class="column-count">3</div>
                            </div>
                            <div class="column-content" data-status="design">
                                <!-- TARJETA 1 -->
                                <div class="kanban-card design" draggable="true" data-id="1" onclick="viewPiezaKanban(1)">
                                    <div class="card-header">
                                        <span class="card-codigo">PZ-025</span>
                                        <span class="card-priority priority-alta">ALTA</span>
                                    </div>
                                    <div class="card-image">
                                        <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Plano CNC">
                                        <div class="card-overlay">
                                            <span><i class="fas fa-file-pdf"></i> plano.pdf</span>
                                            <span>2.5 MB</span>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Soporte Motor Industrial</h3>
                                    <div class="card-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-weight-hanging"></i>
                                            <span>Acero 1018</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>8h estimadas</span>
                                        </div>
                                    </div>
                                    <div class="card-tags">
                                        <span class="tag material">Acero</span>
                                        <span class="tag">CNC</span>
                                        <span class="tag urgente">Urgente</span>
                                    </div>
                                    <div class="card-progress">
                                        <div class="progress-info">
                                            <span>Progreso</span>
                                            <span>30%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 30%"></div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="card-time">
                                            <i class="far fa-calendar"></i>
                                            <span>Iniciado: 15 Mar</span>
                                        </div>
                                        <div class="card-actions">
                                            <button class="action-btn-small" onclick="event.stopPropagation(); editPiezaKanban(1)">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="action-btn-small" onclick="event.stopPropagation(); uploadPlano(1)">
                                                <i class="fas fa-upload"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA 2: FABRICACIÓN -->
                        <div class="kanban-column fabricacion">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-industry"></i>
                                    <span>Fabricación</span>
                                </div>
                                <div class="column-count">4</div>
                            </div>
                            <div class="column-content" data-status="fabricacion">
                                <!-- TARJETA 3 -->
                                <div class="kanban-card fabricacion" draggable="true" data-id="3" onclick="viewPiezaKanban(3)">
                                    <div class="card-header">
                                        <span class="card-codigo">PZ-023</span>
                                        <span class="card-priority priority-alta">ALTA</span>
                                    </div>
                                    <div class="card-image">
                                        <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Pieza en CNC">
                                        <div class="card-overlay">
                                            <span><i class="fas fa-camera"></i> 5 fotos</span>
                                            <span>En máquina</span>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Engrane Helicoidal</h3>
                                    <div class="card-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-weight-hanging"></i>
                                            <span>Acero 4140</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>6.5h / 8h</span>
                                        </div>
                                    </div>
                                    <div class="card-tags">
                                        <span class="tag material">Acero Templado</span>
                                        <span class="tag">CNC 5 Ejes</span>
                                        <span class="tag urgente">Prioridad</span>
                                    </div>
                                    <div class="card-progress">
                                        <div class="progress-info">
                                            <span>Progreso</span>
                                            <span>80%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 80%"></div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="card-time">
                                            <i class="fas fa-user"></i>
                                            <span>Operario: Carlos</span>
                                        </div>
                                        <div class="card-actions">
                                            <button class="action-btn-small" onclick="event.stopPropagation(); registrarTiempoKanban(3)">
                                                <i class="fas fa-stopwatch"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA 3: CONTROL CALIDAD -->
                        <div class="kanban-column control">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-clipboard-check"></i>
                                    <span>Control Calidad</span>
                                </div>
                                <div class="column-count">2</div>
                            </div>
                            <div class="column-content" data-status="control">
                                <!-- TARJETA 5 -->
                                <div class="kanban-card control" draggable="true" data-id="5" onclick="viewPiezaKanban(5)">
                                    <div class="card-header">
                                        <span class="card-codigo">PZ-021</span>
                                        <span class="card-priority priority-media">MEDIA</span>
                                    </div>
                                    <div class="card-image">
                                        <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Control dimensional">
                                        <div class="card-overlay">
                                            <span><i class="fas fa-ruler"></i> Mediciones</span>
                                            <span>3/5 checks</span>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Placa Base CNC</h3>
                                    <div class="card-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-weight-hanging"></i>
                                            <span>Aluminio 7075</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>10.5h total</span>
                                        </div>
                                    </div>
                                    <div class="card-tags">
                                        <span class="tag material">Aluminio Aeronáutico</span>
                                        <span class="tag">Fresado</span>
                                        <span class="tag">Calibración</span>
                                    </div>
                                    <div class="card-progress">
                                        <div class="progress-info">
                                            <span>Inspección</span>
                                            <span>60%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 60%"></div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="card-time">
                                            <i class="fas fa-user-check"></i>
                                            <span>Inspector: Roberto</span>
                                        </div>
                                        <div class="card-actions">
                                            <button class="action-btn-small" onclick="event.stopPropagation(); addCheck(5)">
                                                <i class="fas fa-check-circle"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA 4: TERMINADO -->
                        <div class="kanban-column terminado">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-check-double"></i>
                                    <span>Terminado</span>
                                </div>
                                <div class="column-count">3</div>
                            </div>
                            <div class="column-content" data-status="terminado">
                                <!-- TARJETA 6 -->
                                <div class="kanban-card terminado" draggable="true" data-id="6" onclick="viewPiezaKanban(6)">
                                    <div class="card-header">
                                        <span class="card-codigo">PZ-020</span>
                                        <span class="card-priority priority-baja">BAJA</span>
                                    </div>
                                    <div class="card-image">
                                        <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Pieza terminada">
                                        <div class="card-overlay">
                                            <span><i class="fas fa-award"></i> Aprobada</span>
                                            <span>100% calidad</span>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Caja Reductora</h3>
                                    <div class="card-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-weight-hanging"></i>
                                            <span>Acero 1045</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>15h total</span>
                                        </div>
                                    </div>
                                    <div class="card-tags">
                                        <span class="tag material">Acero al Carbono</span>
                                        <span class="tag">Ensamblaje</span>
                                        <span class="tag">Pruebas OK</span>
                                    </div>
                                    <div class="card-tags">
                                        <span class="tag" style="background: #e3f2fd; color: #1565c0;">
                                            <i class="fas fa-box"></i> Stock: 5 unidades
                                        </span>
                                    </div>
                                    <div class="card-footer">
                                        <div class="card-time">
                                            <i class="far fa-calendar-check"></i>
                                            <span>Terminado: 20 Mar</span>
                                        </div>
                                        <div class="card-actions">
                                            <button class="action-btn-small" onclick="event.stopPropagation(); moverAEntregado(6)">
                                                <i class="fas fa-shipping-fast"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA 5: ENTREGADO -->
                        <div class="kanban-column entregado">
                            <div class="column-header">
                                <div class="column-title">
                                    <i class="fas fa-shipping-fast"></i>
                                    <span>Entregado</span>
                                </div>
                                <div class="column-count">2</div>
                            </div>
                            <div class="column-content" data-status="entregado">
                                <!-- TARJETA 7 -->
                                <div class="kanban-card entregado" draggable="true" data-id="7" onclick="viewPiezaKanban(7)">
                                    <div class="card-header">
                                        <span class="card-codigo">PZ-019</span>
                                        <span class="card-priority priority-baja">BAJA</span>
                                    </div>
                                    <div class="card-image">
                                        <img src="https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="Pieza entregada">
                                        <div class="card-overlay">
                                            <span><i class="fas fa-truck"></i> Entregado</span>
                                            <span>Factura #2456</span>
                                        </div>
                                    </div>
                                    <h3 class="card-title">Soporte Motor Diesel</h3>
                                    <div class="card-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-weight-hanging"></i>
                                            <span>Acero 1018</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-clock"></i>
                                            <span>9h total</span>
                                        </div>
                                    </div>
                                    <div class="card-tags">
                                        <span class="tag material">Acero Estructural</span>
                                        <span class="tag">Soldado</span>
                                        <span class="tag">Pintado</span>
                                    </div>
                                    <div class="card-footer">
                                        <div class="card-time">
                                            <i class="far fa-calendar-alt"></i>
                                            <span>Entregado: 18 Mar</span>
                                        </div>
                                        <div class="card-actions">
                                            <button class="action-btn-small" onclick="event.stopPropagation(); verFactura(7)">
                                                <i class="fas fa-file-invoice"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== OTRAS PÁGINAS (simplificadas) ========== -->
                <div id="piezas" class="page-content">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-cogs"></i> Piezas Fabricadas - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <div class="header-controls">
                            <button class="btn btn-success" onclick="showModal('modal-nueva-pieza')">
                                <i class="fas fa-plus"></i> Nueva Pieza
                            </button>
                            <button class="btn btn-primary" onclick="navigateTo('kanban')">
                                <i class="fas fa-th-large"></i> Ver Tablero Kanban
                            </button>
                        </div>
                    </div>
                    <div class="management-container">
                        <div class="section">
                            <p>Módulo de gestión de piezas - Contenido completo del sistema</p>
                        </div>
                    </div>
                </div>

                <div id="inventario" class="page-content">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-boxes"></i> Inventario de Materiales - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <button class="btn btn-success">
                            <i class="fas fa-plus"></i> Agregar Material
                        </button>
                    </div>
                    <div class="management-container">
                        <div class="section">
                            <p>Módulo de inventario - Contenido similar al de piezas</p>
                        </div>
                    </div>
                </div>

                <div id="herramientas" class="page-content">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-tools"></i> Gestión de Herramientas - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <button class="btn btn-success">
                            <i class="fas fa-plus"></i> Nueva Herramienta
                        </button>
                    </div>
                    <div class="management-container">
                        <div class="section">
                            <p>Módulo de herramientas - Contenido similar</p>
                        </div>
                    </div>
                </div>

                <div id="planos" class="page-content">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-file-pdf"></i> Gestión de Planos - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <button class="btn btn-success">
                            <i class="fas fa-plus"></i> Subir Plano
                        </button>
                    </div>
                    <div class="management-container">
                        <div class="section">
                            <p>Módulo de planos - Gestión de archivos CAD/DWG/PDF</p>
                        </div>
                    </div>
                </div>

                <div id="reportes" class="page-content">
                    <div class="page-header">
                        <div style="display: flex; align-items: center;">
                            <button class="btn-menu-toggle" onclick="toggleSidebar()">
                                <i class="fas fa-bars"></i>
                            </button>
                            <h1 class="page-title"><i class="fas fa-chart-bar"></i> Reportes y Estadísticas - <span class="corinfar-logo">CORINFAR</span> <span class="corinfar-title">Taller</span></h1>
                        </div>
                        <button class="btn btn-primary">
                            <i class="fas fa-download"></i> Exportar Reporte
                        </button>
                    </div>
                    <div class="management-container">
                        <div class="section">
                            <p>Módulo de reportes - Gráficos y estadísticas de producción</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODALES COMUNES -->
    <!-- MODAL DETALLE PIEZA -->
    <div id="modal-pieza-detalle" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> <span id="modalPiezaNombre">Soporte Motor Industrial</span> - <span class="corinfar-logo">CORINFAR</span></h2>
                <button class="close-modal" onclick="closeModal('modal-pieza-detalle')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="padding: 20px;">
                    <h3>Detalles completos de la pieza</h3>
                    <p>Aquí iría toda la información detallada, lista de materiales, herramientas, tiempos, etc.</p>
                    <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="info-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div class="info-label">Código</div>
                            <div class="info-value" id="detalle-codigo">PZ-025</div>
                        </div>
                        <div class="info-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div class="info-label">Material</div>
                            <div class="info-value" id="detalle-material">Acero 1018</div>
                        </div>
                        <div class="info-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div class="info-label">Tiempo Estimado</div>
                            <div class="info-value" id="detalle-tiempo">8 horas</div>
                        </div>
                        <div class="info-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div class="info-label">Prioridad</div>
                            <div class="info-value" id="detalle-prioridad">Alta</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 20px;" onclick="closeModal('modal-pieza-detalle')">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVA PIEZA -->
    <div id="modal-nueva-pieza" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus"></i> Registrar Nueva Pieza - <span class="corinfar-logo">CORINFAR</span></h2>
                <button class="close-modal" onclick="closeModal('modal-nueva-pieza')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-nueva-pieza" style="padding: 20px;">
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <label for="codigo" style="display: block; margin-bottom: 8px; font-weight: 600;">Código de Pieza *</label>
                            <input type="text" id="codigo" placeholder="Ej: PZ-025" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="nombre" style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre de Pieza *</label>
                            <input type="text" id="nombre" placeholder="Ej: Soporte Motor" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label for="descripcion" style="display: block; margin-bottom: 8px; font-weight: 600;">Descripción</label>
                        <textarea id="descripcion" placeholder="Descripción detallada de la pieza..." style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px; min-height: 100px;"></textarea>
                    </div>

                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <label for="material" style="display: block; margin-bottom: 8px; font-weight: 600;">Material Principal *</label>
                            <select id="material" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                                <option value="">Seleccionar material...</option>
                                <option value="Acero 1018">Acero 1018</option>
                                <option value="Acero 4140">Acero 4140</option>
                                <option value="Acero Inox 304">Acero Inox 304</option>
                                <option value="Aluminio 6061">Aluminio 6061</option>
                                <option value="Bronce">Bronce</option>
                                <option value="Nylon">Nylon (Grilon)</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="tiempo-estimado" style="display: block; margin-bottom: 8px; font-weight: 600;">Tiempo Estimado (horas) *</label>
                            <input type="number" id="tiempo-estimado" step="0.1" min="0" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                    </div>

                    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                        <div style="flex: 2;">
                            <label for="maquina-vinculo" style="display: block; margin-bottom: 8px; font-weight: 600;">Vincular a Máquina (CMMS) *</label>
                            <select id="maquina-vinculo" required style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                                <option value="">Cargando máquinas...</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label for="stock-minimo" style="display: block; margin-bottom: 8px; font-weight: 600;">Stock Mínimo</label>
                            <input type="number" id="stock-minimo" value="1" min="0" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="stock-maximo" style="display: block; margin-bottom: 8px; font-weight: 600;">Stock Máximo</label>
                            <input type="number" id="stock-maximo" value="5" min="0" style="width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 10px;">
                        </div>
                    </div>

                    <div style="text-align: right;">
                        <button type="button" class="btn btn-filter" onclick="closeModal('modal-nueva-pieza')" style="margin-right: 10px;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Pieza
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>

// ========== CONFIGURACIÓN FIREBASE ==========
const firebaseConfig = {
    apiKey: "AIzaSyCnAxQqlkVzEPpcwXLO-MhIfK0517lSvT4",
    authDomain: "gestion-de-mantenimeinto.firebaseapp.com",
    projectId: "gestion-de-mantenimeinto",
    storageBucket: "gestion-de-mantenimeinto.firebasestorage.app",
    messagingSenderId: "1098054951785",
    appId: "1:1098054951785:web:5522bbfb185a05f674d3f8", // Actualizado según screenshot
    measurementId: "G-JN15RHJD2C"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const firestore = firebase.firestore();

const PATHS = {
    workOrders: 'public/data/workOrders',
    parts: 'public/data/parts',
    workshopPieces: 'piezasTaller',
    users: 'users',
    machines: 'public/data/machines'
};

// ========== VARIABLES DE ESTADO ==========
let usuarioLogueado = null;
let piezasKanban = {};
let tallerInventory = {};
let maquinas = {};

// ========== SISTEMA DE AUTENTICACIÓN ==========
function login() {
    let user = document.getElementById('username').value;
    const pass = document.getElementById('password').value;
    const remember = document.getElementById('remember').checked;

    if (!user || !pass) {
        showNotification('Por favor ingrese usuario y contraseña', 'error');
        return;
    }

    // Auto-completar dominio si no es un correo
    if (user && !user.includes('@')) {
        user = `${user}@corinfar.com`;
    }

    const loginBtn = document.querySelector('.login-btn');
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accediendo...';
    loginBtn.disabled = true;

    const persistence = remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;

    auth.setPersistence(persistence).then(() => {
        return auth.signInWithEmailAndPassword(user, pass);
    }).then((userCredential) => {
        const uid = userCredential.user.uid;
        return firestore.collection(PATHS.users).doc(uid).get();
    }).then(doc => {
        if (doc.exists) {
            usuarioLogueado = doc.data();
            finishLogin();
        } else {
            // Crear perfil automático si no existe en Firestore
            const newUser = {
                uid: auth.currentUser.uid,
                email: auth.currentUser.email,
                name: auth.currentUser.email.split('@')[0],
                roleName: 'Operario Taller',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            return firestore.collection(PATHS.users).doc(newUser.uid).set(newUser).then(() => {
                usuarioLogueado = newUser;
                finishLogin();
            });
        }
    }).catch(error => {
        console.error(error);
        showNotification('Error de acceso: ' + error.message, 'error');
        loginBtn.innerHTML = 'Iniciar Sesión';
        loginBtn.disabled = false;
    });
}

function finishLogin() {
    showNotification('Bienvenido al Sistema Corinfar', 'success');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainSystem').style.display = 'flex';
    initSystem();
}

function logout() {
    auth.signOut().then(() => {
        location.reload();
    });
}

function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function checkExistingSession() {
    auth.onAuthStateChanged(user => {
        if (user) {
            console.log("Sesión detectada para:", user.email);
            firestore.collection(PATHS.users).doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    usuarioLogueado = doc.data();
                } else {
                    console.log("Perfil no encontrado, creando perfil temporal");
                    usuarioLogueado = {
                        uid: user.uid,
                        email: user.email,
                        name: user.email.split('@')[0],
                        roleName: 'Operario Taller'
                    };
                }
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'flex';
                initSystem();
            }).catch(error => {
                console.error("Error al recuperar perfil:", error);
                usuarioLogueado = {
                    uid: user.uid,
                    email: user.email,
                    name: user.email.split('@')[0],
                    roleName: 'Operario Taller'
                };
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'flex';
                initSystem();
            });
        }
    });
}

// ========== GESTIÓN DE DATOS Y UI ==========
function navigateTo(pageId) {
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if (targetPage) targetPage.classList.add('active');

    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === pageId) {
            link.classList.add('active');
        }
    });

    if (pageId === 'inventario') updateInventoryUI();
}

function initSystem() {
    // Actualizar Info Usuario
    const userNameEl = document.getElementById('sidebarUserName');
    const userRoleEl = document.getElementById('sidebarUserRole');
    if (userNameEl) userNameEl.textContent = usuarioLogueado.name;
    if (userRoleEl) userRoleEl.textContent = usuarioLogueado.roleName || 'Operario Taller';

    // Listeners de Firestore
    firestore.collection(PATHS.workOrders)
        .onSnapshot(snapshot => {
            console.log("WorkOrders recibidas:", snapshot.size);
            const workOrders = {};
            snapshot.forEach(doc => {
                workOrders[doc.id] = doc.data();
            });
            renderSolicitudes(workOrders);
        }, error => {
            console.error("Error en workOrders:", error);
            if (error.code === 'permission-denied') {
                showNotification("Acceso denegado a Solicitudes CMMS", "error");
            }
        });

    firestore.collection(PATHS.workshopPieces)
        .onSnapshot(snapshot => {
            console.log("Piezas Taller recibidas:", snapshot.size);
            piezasKanban = {};
            snapshot.forEach(doc => {
                piezasKanban[doc.id] = doc.data();
            });
            renderWorkshopPieces(piezasKanban);
            renderRecentPieces(piezasKanban);
            updateDashboardStats();
        }, error => console.error("Error en piezasTaller:", error));

    firestore.collection(PATHS.parts)
        .onSnapshot(snapshot => {
            console.log("Inventario CMMS recibido:", snapshot.size);
            tallerInventory = {};
            snapshot.forEach(doc => {
                tallerInventory[doc.id] = doc.data();
            });
            updateInventoryUI();
        }, error => {
            console.error("Error en parts:", error);
        });

    firestore.collection(PATHS.machines)
        .onSnapshot(snapshot => {
            console.log("Máquinas recibidas de Firestore:", snapshot.size);
            maquinas = {};
            snapshot.forEach(doc => {
                maquinas[doc.id] = doc.data();
            });
            renderMachinesList();
        }, error => {
            console.error("Error en machines:", error);
            showNotification("Error cargando máquinas: " + error.message, "error");
        });

    setupNavigation();
    initKanbanDragAndDrop();
}

function renderSolicitudes(workOrders) {
    const container = document.querySelector('[data-status="solicitudes"]');
    if (!container) return;
    container.innerHTML = '';

    let pendingCount = 0;
    Object.keys(workOrders).forEach(id => {
        const order = workOrders[id];

        // Filtro solicitado: Mostrar solo OTs de "mecanizado" que no hayan sido aceptadas
        const isMecanizado = (order.label === 'mecanizado' ||
                             order.type === 'mecanizado' ||
                             (order.tags && order.tags.includes('mecanizado')) ||
                             order.category === 'mecanizado');

        if (order.tallerStatus !== 'accepted' && isMecanizado) {
            const card = createCardHTML(id, order, 'solicitudes');
            container.appendChild(card);
            pendingCount++;
        }
    });
    updateColumnCounts();

    // Update Dashboard "Pedidos Pendientes"
    const stats = document.querySelectorAll('.stat-info h3');
    if (stats[3]) stats[3].textContent = pendingCount;
}

function renderMachinesList() {
    console.log("Actualizando lista de máquinas...", maquinas);
    const select = document.getElementById('maquina-vinculo');
    if (!select) {
        console.error("No se encontró el select 'maquina-vinculo'");
        return;
    }

    const currentValue = select.value;
    select.innerHTML = '<option value="">Seleccionar máquina...</option>';

    const machineEntries = Object.keys(maquinas);
    console.log(`Encontradas ${machineEntries.length} máquinas`);

    if (machineEntries.length === 0) {
        select.innerHTML = '<option value="">No hay máquinas disponibles</option>';
        return;
    }

    const sortedMachines = machineEntries
        .map(id => ({id, ...maquinas[id]}))
        .sort((a, b) => (a.name || '').localeCompare(b.name || ''));

    sortedMachines.forEach(m => {
        const option = document.createElement('option');
        option.value = m.id;
        option.textContent = m.name || m.id;
        select.appendChild(option);
    });

    if (currentValue && maquinas[currentValue]) {
        select.value = currentValue;
    }
}

function renderWorkshopPieces(pieces) {
    const columns = ['design', 'fabricacion', 'control', 'terminado', 'entregado'];
    columns.forEach(status => {
        const container = document.querySelector(`[data-status="${status}"]`);
        if (container) container.innerHTML = '';
    });

    Object.keys(pieces).forEach(id => {
        const piece = pieces[id];
        const container = document.querySelector(`[data-status="${piece.estado}"]`);
        if (container) {
            const card = createCardHTML(id, piece, piece.estado);
            container.appendChild(card);
        }
    });
    updateColumnCounts();
}

function renderRecentPieces(pieces) {
    const tbody = document.querySelector('#dashboard tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const sortedPieces = Object.keys(pieces)
        .map(id => ({id, ...pieces[id]}))
        .sort((a, b) => (b.fechaInicio || '').localeCompare(a.fechaInicio || ''))
        .slice(0, 5);

    if (sortedPieces.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No hay piezas registradas</td></tr>';
        return;
    }

    sortedPieces.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.codigo || '---'}</td>
            <td>${p.nombre || '---'}</td>
            <td>${p.material || '---'}</td>
            <td>${p.tiempoEstimado || '---'}</td>
            <td><span class="badge ${p.estado === 'terminado' ? 'badge-success' : 'badge-warning'}">${p.estado}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn btn-view" onclick="viewPiezaKanban('${p.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function createCardHTML(id, data, type) {
    const div = document.createElement('div');
    div.className = `kanban-card ${type}`;
    div.draggable = true;
    div.dataset.id = id;
    div.dataset.type = type === 'solicitudes' ? 'order' : 'piece';

    const priorityClass = `priority-${(data.prioridad || 'media').toLowerCase()}`;
    const progress = data.progreso || 0;
    const imgUrl = data.imageUrl || (type === 'solicitudes' ?
        "https://images.unsplash.com/photo-1537462715879-360eeb61a0ad?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" :
        "https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80");

    div.innerHTML = `
        <div class="card-header">
            <span class="card-codigo">${data.codigo || 'S/C'}</span>
            <span class="card-priority ${priorityClass}">${(data.prioridad || 'MEDIA').toUpperCase()}</span>
        </div>
        <div class="card-image">
            <img src="${imgUrl}" alt="${data.nombre || 'Pieza'}">
            <div class="card-overlay">
                <span><i class="fas fa-info-circle"></i> Detalle</span>
            </div>
        </div>
        <h3 class="card-title">${data.nombre || data.description || 'Sin Título'}</h3>
        <div class="card-meta">
            <div class="meta-item">
                <i class="fas fa-weight-hanging"></i>
                <span>${data.material || 'Material N/D'}</span>
            </div>
            <div class="meta-item">
                <i class="fas fa-clock"></i>
                <span>${data.tiempoEstimado || (data.estimatedTime ? data.estimatedTime + 'h' : '---')}</span>
            </div>
        </div>
        <div class="card-tags">
            ${data.tags ? data.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : '<span class="tag">General</span>'}
            ${(data.prioridad === 'ALTA' || data.prioridad === 'alta') ? '<span class="tag urgente">Urgente</span>' : ''}
        </div>
        <div class="card-progress">
            <div class="progress-info">
                <span>${type === 'control' ? 'Inspección' : 'Progreso'}</span>
                <span>${progress}%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
        </div>
        <div class="card-footer">
            <div class="card-time">
                <i class="${type === 'solicitudes' ? 'far fa-calendar' : 'fas fa-user'}"></i>
                <span>${type === 'solicitudes' ? (data.fecha || 'Pendiente') : (data.operario || 'Sin asignar')}</span>
            </div>
            <div class="card-actions">
                ${type === 'solicitudes' ?
                    `<button class="action-btn-small" title="Aceptar" onclick="event.stopPropagation(); acceptWorkOrder('${id}')">
                        <i class="fas fa-check"></i>
                    </button>` :
                    `<button class="action-btn-small" onclick="event.stopPropagation(); editPiezaKanban('${id}')">
                        <i class="fas fa-edit"></i>
                    </button>`
                }
            </div>
        </div>
    `;

    div.addEventListener('dragstart', handleDragStart);
    div.addEventListener('dragend', handleDragEnd);
    div.onclick = () => type === 'solicitudes' ? viewWorkOrder(id) : viewPiezaKanban(id);

    return div;
}

// ========== ACCIONES KANBAN ==========
function acceptWorkOrder(id) {
    const docRef = firestore.collection(PATHS.workOrders).doc(id);
    docRef.get().then(doc => {
        if (!doc.exists) return;
        const order = doc.data();

        const newPiece = {
            nombre: order.nombre || order.description || 'Sin Nombre',
            codigo: order.codigo || 'PZ-CMMS',
            material: order.material || 'Por definir',
            prioridad: order.prioridad || 'media',
            estado: 'design',
            progreso: 0,
            imageUrl: order.imageUrl || null,
            cmmsId: id,
            fechaInicio: new Date().toLocaleDateString(),
            operario: 'Sin asignar'
        };

        return firestore.collection(PATHS.workshopPieces).add(newPiece).then(pieceRef => {
            return docRef.update({
                tallerStatus: 'accepted',
                tallerPieceId: pieceRef.id,
                status: 'En Proceso (Taller)'
            });
        });
    }).then(() => {
        showNotification('Trabajo aceptado y movido a Diseño', 'success');
    }).catch(error => {
        console.error("Error al aceptar OT:", error);
        showNotification('Error al aceptar el trabajo', 'error');
    });
}

function handleDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.id);
    e.dataTransfer.setData('type', e.target.dataset.type);
    setTimeout(() => e.target.classList.add('dragging'), 0);
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function initKanbanDragAndDrop() {
    const columns = document.querySelectorAll('.column-content');
    columns.forEach(column => {
        column.addEventListener('dragover', e => {
            e.preventDefault();
            column.classList.add('drag-over');
        });
        column.addEventListener('dragleave', () => {
            column.classList.remove('drag-over');
        });
        column.addEventListener('drop', e => {
            e.preventDefault();
            column.classList.remove('drag-over');
            const id = e.dataTransfer.getData('text/plain');
            const type = e.dataTransfer.getData('type');
            const newStatus = column.dataset.status;

            if (type === 'order' && newStatus === 'design') {
                acceptWorkOrder(id);
            } else if (type === 'piece') {
                updatePieceStatus(id, newStatus);
            }
        });
    });
}

function updatePieceStatus(id, newStatus) {
    const docRef = firestore.collection(PATHS.workshopPieces).doc(id);
    const updates = { estado: newStatus };

    if (newStatus === 'terminado') {
        updates.progreso = 100;
        updates.fechaFin = new Date().toLocaleDateString();
        syncWithCMMSInventory(id, 1);
    }

    docRef.update(updates).catch(error => {
        console.error("Error al actualizar estado:", error);
    });
}

async function syncWithCMMSInventory(pieceId, increment = 0) {
    console.log(`Sincronizando ${pieceId} con CMMS. Incremento: ${increment}`);

    // Obtener datos de la pieza (desde el estado local o Firestore)
    let piece = piezasKanban[pieceId];
    if (!piece) {
        try {
            const doc = await firestore.collection(PATHS.workshopPieces).doc(pieceId).get();
            if (doc.exists) piece = doc.data();
        } catch (e) { console.error(e); }
    }

    if (!piece) return;

    try {
        const partsRef = firestore.collection(PATHS.parts);
        // Buscar si ya existe por código o nombre
        const queryByCode = await partsRef.where('code', '==', piece.codigo).get();
        let targetDocId = null;
        let currentStock = 0;

        if (!queryByCode.empty) {
            targetDocId = queryByCode.docs[0].id;
            currentStock = queryByCode.docs[0].data().stock || 0;
        } else {
            const queryByName = await partsRef.where('name', '==', piece.nombre).get();
            if (!queryByName.empty) {
                targetDocId = queryByName.docs[0].id;
                currentStock = queryByName.docs[0].data().stock || 0;
            }
        }

        const partData = {
            name: piece.nombre,
            code: piece.codigo,
            description: piece.descripcion || '',
            material: piece.material,
            status: 'Available',
            origin: 'Workshop',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            workshopPieceId: pieceId,
            machineId: piece.maquinaId || null,
            stockMinimo: parseInt(piece.stockMinimo) || 0,
            stockMaximo: parseInt(piece.stockMaximo) || 0,
            stock: currentStock + increment
        };

        if (targetDocId) {
            await partsRef.doc(targetDocId).update(partData);
            console.log("Pieza actualizada en inventario CMMS");
        } else {
            await partsRef.add({
                ...partData,
                addedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log("Pieza creada en inventario CMMS");
        }

        if (increment > 0) {
            showNotification('Stock actualizado en inventario CMMS', 'success');
        }
    } catch (error) {
        console.error("Error al sincronizar con CMMS:", error);
    }
}

// ========== OTROS COMPONENTES UI ==========
function showNotification(msg, type) {
    const notif = document.createElement('div');
    notif.className = 'notification-toast';
    notif.style.position = 'fixed';
    notif.style.top = '20px';
    notif.style.right = '20px';
    notif.style.padding = '15px 25px';
    notif.style.borderRadius = '5px';
    notif.style.color = 'white';
    notif.style.zIndex = '9999';
    notif.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    notif.style.background = type === 'success' ? '#27ae60' : '#e74c3c';
    notif.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${msg}`;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}

function setupNavigation() {
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.onclick = (e) => {
            e.preventDefault();
            const target = link.getAttribute('data-page');
            if (!target) return;
            
            navigateTo(target);

            // Close sidebar on mobile after clicking a link
            if (window.innerWidth <= 1200) {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar) sidebar.classList.remove('active');
                if (overlay) overlay.classList.remove('active');
            }
        };
    });
}

function updateColumnCounts() {
    document.querySelectorAll('.kanban-column').forEach(col => {
        const count = col.querySelectorAll('.kanban-card').length;
        const badge = col.querySelector('.column-count');
        if (badge) badge.textContent = count;
    });
}

function updateDashboardStats() {
    const pieces = Object.values(piezasKanban);
    const active = pieces.filter(p => p.estado !== 'terminado' && p.estado !== 'entregado').length;
    const finished = pieces.filter(p => p.estado === 'terminado').length;

    const stats = document.querySelectorAll('.stat-info h3');
    if (stats[0]) stats[0].textContent = active;
    if (stats[1]) stats[1].textContent = finished;

    // Note: Solicitudes are updated in renderSolicitudes
    // Stock Bajo is updated in updateInventoryUI
}

function updateInventoryUI() {
    const container = document.querySelector('#inventario .section');
    const alertContainer = document.querySelector('.alertas');
    const stats = document.querySelectorAll('.stat-info h3');

    let html = '<div class="table-responsive"><table><thead><tr><th>Nombre</th><th>Origen</th><th>Estado</th></tr></thead><tbody>';

    let lowStockCount = 0;
    let alertsHtml = '';

    const items = Object.values(tallerInventory);
    if (items.length === 0) {
        html += '<tr><td colspan="3" style="text-align:center">No hay piezas en el inventario CMMS</td></tr>';
    } else {
        items.forEach(item => {
            html += `
                <tr>
                    <td>${item.name || '---'}</td>
                    <td>${item.origin || '---'}</td>
                    <td>${item.status || '---'}</td>
                </tr>
            `;
            if (item.status === 'Low' || (item.stock !== undefined && item.stock < 5)) {
                lowStockCount++;
                alertsHtml += `<div class="alerta-item" style="padding: 15px; border-left: 4px solid #f39c12; background: #fff3cd; margin-bottom: 10px; border-radius: 0 5px 5px 0;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>${item.name}:</strong> Stock Bajo
                </div>`;
            }
        });
    }

    html += '</tbody></table></div>';

    if (container) container.innerHTML = html;
    if (alertContainer) alertContainer.innerHTML = alertsHtml || '<p>No hay alertas de inventario</p>';
    if (stats[2]) stats[2].textContent = lowStockCount;
}

function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.style.display = 'none';
}

function showModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
        modal.style.display = 'flex';
        // Si el modal es el de nueva pieza, asegurar que las máquinas estén cargadas
        if (id === 'modal-nueva-pieza') {
            renderMachinesList();
        }
    }
}

function viewWorkOrder(id) { alert('Detalle de orden: ' + id); }
function viewPiezaKanban(id) { alert('Detalle de pieza: ' + id); }
function editPiezaKanban(id) { alert('Editar pieza: ' + id); }

function saveNewPiece() {
    const codigo = document.getElementById('codigo').value;
    const nombre = document.getElementById('nombre').value;
    const descripcion = document.getElementById('descripcion').value;
    const material = document.getElementById('material').value;
    const tiempoEstimado = document.getElementById('tiempo-estimado').value;
    const maquinaId = document.getElementById('maquina-vinculo').value;
    const stockMin = parseInt(document.getElementById('stock-minimo').value) || 0;
    const stockMax = parseInt(document.getElementById('stock-maximo').value) || 0;

    if (!codigo || !nombre || !material || !tiempoEstimado || !maquinaId) {
        showNotification('Por favor complete los campos obligatorios', 'error');
        return;
    }

    const newPiece = {
        codigo,
        nombre,
        descripcion,
        material,
        tiempoEstimado: tiempoEstimado + 'h',
        maquinaId,
        stockMinimo: stockMin,
        stockMaximo: stockMax,
        estado: 'design',
        progreso: 0,
        fechaInicio: new Date().toLocaleDateString(),
        operario: 'Sin asignar',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    const saveBtn = document.querySelector('#form-nueva-pieza button[type="submit"]');
    const originalBtnText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    saveBtn.disabled = true;

    let createdPieceId = null;
    firestore.collection(PATHS.workshopPieces).add(newPiece).then(docRef => {
        createdPieceId = docRef.id;
        // Vincular en el documento de la máquina como repuesto
        return firestore.collection(PATHS.machines).doc(maquinaId).set({
            spareParts: firebase.firestore.FieldValue.arrayUnion({
                workshopPieceId: docRef.id,
                name: nombre,
                code: codigo
            })
        }, { merge: true });
    }).then(() => {
        // Registrar en CMMS inmediatamente con stock 0
        return syncWithCMMSInventory(createdPieceId, 0);
    }).then(() => {
        showNotification('Pieza registrada y vinculada exitosamente', 'success');
        closeModal('modal-nueva-pieza');
        document.getElementById('form-nueva-pieza').reset();
    }).catch(error => {
        console.error("Error al guardar pieza:", error);
        showNotification('Error al guardar la pieza: ' + error.message, 'error');
    }).finally(() => {
        saveBtn.innerHTML = originalBtnText;
        saveBtn.disabled = false;
    });
}

document.addEventListener('DOMContentLoaded', () => {
    // Limpiar tarjetas estáticas
    const columns = ['design', 'fabricacion', 'control', 'terminado', 'entregado'];
    columns.forEach(status => {
        const container = document.querySelector(`[data-status="${status}"]`);
        if (container) container.innerHTML = '';
    });

    checkExistingSession();

    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.onsubmit = (e) => {
            e.preventDefault();
            login();
        };
    }

    const nuevaPiezaForm = document.getElementById('form-nueva-pieza');
    if (nuevaPiezaForm) {
        nuevaPiezaForm.onsubmit = (e) => {
            e.preventDefault();
            saveNewPiece();
        };
    }
});

</script>
</body>
</html>